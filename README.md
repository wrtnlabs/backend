# WrtnLabs Backend
![Wrtn logo](https://github.com/user-attachments/assets/2ce2459f-28af-4ac5-93f9-9372976ff2d6)

## Overview

This backend service powers the WrtnLabs.

All project contributors must review the [ERD Design Document](docs/ERD.md) before starting development work.


## Table of Contents

- [Getting Started](#getting-started)
- [Development](#development)
  - [Development Workflow](#definition)
  - [Test Automation](#test-automation-program)
  - [Main Program Development](#main-program-development)
- [Commands Reference](#commands-reference)
- [Project Structure](#project-structure)
- [Related Repositories](#related-repositories)

## Getting Started
### Required

- Node.js v20+
- PostgreSQL
- pnpm

### Optional

* [AWS](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html) - for aws service authentication

### Main Program

```bash
# Clone repository
git clone https://github.com/wrtnlabs/backend wrtnlabs-backend
cd wrtnlabs-backend

# Install PostgreSQL via Docker
bash postgres.sh 

# Install dependencies and build
pnpm install
pnpm run build

# Set up database
pnpm run schema     # DB schema initialization
pnpm run data:seed  # Seed data insertion
pnpm run start

curl http://localhost:3700/_health
```

> If you contact credentials error when executing the `pnpm run schema` command, please try this command:
> ```bash
> pnpm run schema <your_username> <your_password>
> ```

## SDK
This is a SDK library generated by [`nestia`](https://nestia.io/docs/).

To interact with WrtnLabs Backend APIs and interfaces, use the official SDK `@wrtnlabs/os-api`. The SDK ensures secure API communication and provides interface definitions directly in the code.

### Features of `@wrtnlabs/os-api`
> If you use this SDK, please read this document: [packages/api/README.md](packages/api/README.md)

* Provides typed API communication with DTO structures.
* Eliminates the need for manual API documentation lookup.
* Enables safe and convenient interaction for frontend developers.
* Developers can use predefined interfaces and asynchronous functions without manually redefining API structures.
* More efficient and user-friendly compared to traditional REST API solutions.

When the SDK has been published, client programmers can interact with this backend server very easily. Just let them to install the SDK and call the SDK functions with the `await` symbol like below.

![sdk-demo](https://user-images.githubusercontent.com/13158709/215004990-368c589d-7101-404e-b81b-fbc936382f05.gif)
> Left is server code, and right is client code utilizing the SDK

## Development

### Definition

If you want to add a new feature or update ordinary thing in the API level, you should write the code down to the matched *API controller*, who is stored in the [src/controllers](src/controllers) directory as the [Main Program](#main-program-development).

However, **Wrtnlabs** does not recommend to writing code down into the [Main Program](#main-program-development) first, without any consideration. Instead, **Wrtnlabs** recommends to declare the definition first and implement the [Main Program](#main-program-development) later.

Therefore, if you want to add a new feature in the API level, define the matched data entity in the [prisma](prisma) and [src/api/structures](src/api/structures) directories. After the data entity definition, declare function header in the matched API controller class in the [src/controllers](src/controllers). Note that, it's only the declaration, header only, not meaning to implement the function body.

After those declarations, build the client [SDK](#sdk) through the `npm run build:api` command and implement the [Test Automation Program](#test-automation-program) using the [SDK](#sdk) with use case scenarios. Development of the [Main Program](#main-program-development) should be started after those preparations are all being ready. Of course, the [Main Program](#main-program-development) can be verified with the pre-developed [Test Automation Program](#test-automation-program) in everytime.

- Declare data entity (`prisma` schema file)
- Design API function types, without main program implementation
- Build the client [SDK](#sdk)
- Implement the [Test Automation Program](#test-automation-program)
- Develop the [Main Program](#main-program-development)
- Validate the [Main Program](#main-program-development) through the [Test Automation Program](#test-automation-program)
- Deploy to the Dev and Real servers.

### Test Automation Program
> TDD (Test Driven Development) with SDK

After the [Definition](#definition) and client [SDK](#sdk) generation, you've to design the use-case scenario and implement a test automation program who represents the use-case scenario and guarantees the [Main Program](#main-program-development).

To add a new test function in the Test Automation Program, create a new TS file under the [test/features](test/features) directory following the below category and implement the test scenario function with representative function name and `export` symbol. I think many all of the ordinary files wrote in the [test/features](test/features) directory would be good sample for you. Therefore, I will not describe how the make the test function detaily.

Anyway, you've to remind that, the Test Automation Program resets the DB schema whenever being run. Therefore, you've to be careful if import data has been stored in the local (or dev) DB server. To avoid the resetting the DB, configure the `skipReset` option like below.

Also, the Test Automation Program runs all of the test functions placed into the [test/features](test/features) directory. However, those full testing may consume too much time. Therefore, if you want to reduce the testing time by specializing some test functions, use the `include` option like below.

- `include`: test only restricted functions who is containing the special keyword.
- `exclude`: exclude some functions who is containing the special keyword.
- `reset`: do not reset the DB

```bash
# test without db reset
npm run test -- --reset false

# include or exclude some features
npm run test -- --include something
npm run test -- --include cart order issue
npm run test -- --include cart order issue --exclude index deposit

# run performance benchmark program
npm run benchmark
```

For reference, if you run `npm run benchmark` command, your test functions defined in the [test/features/api](test/features/api) directory would be utilized for performance benchmarking. If you want to see the performance bench result earlier, visit below link please:

- [docs/benchmarks/AMD Ryzen 9 7940HS w Radeon 780M Graphics.md](docs/benchmarks/api/AMD%20Ryzen%209%207940HS%20w%20Radeon%20780M%20Graphics.md)
- [docs/benchmarks/Apple m2 pro](docs/benchmarks/api/Apple%20M2%20Pro.md)

### Main Program Development

After [Definition](#definition), client [SDK](#sdk) building and [Test Automation Program](#test-automation-program) are all prepared, finally you can develop the Main Program. Also, when you've completed the Main Program implementation, it would better to validate the implementation through the pre-built [SDK](#sdk) and [Test Automation Program](#test-automation-program).

However, do not commit a mistake that writing source codes only in the [controller](src/controllers) classes. The API Controller must have a role that only intermediation. The main source code should be write down separately following the directory categorizing. For example, source code about DB I/O should be written into the [src/providers](src/providers) directory.

## Commands Reference

### Testing

- `test`: Run test program (requires prior `build:test` or `dev`)
- `benchmark`: Run performance benchmark program

### Building

- `build`: Build SDK, test, and main programs
- `build:sdk`: Build SDK library (local only)
- `build:test`: Build test program
- `build:main`: Build main program
- `dev`: Incremental builder for test program
- `eslint`: Run ESLint
- `prettier`: Apply Prettier formatting

### Deployment

- `schema`: Automatic local DB schema generator
- `start`: Run backend server standalone
- `start:mutex`: Run mutex server standalone
- `start:proxy`: Run proxy server standalone
- `start:swagger`: Run backend swagger viewer

### Data

- `data:seed`: Seed data insertion
- `data:view`: Refresh view data

## Project Structure

- `.vscode/launch.json`: Debugging configuration
- `packages/`: NPM modules to publish
  - `packages/api/`: Client SDK library
- `docs/`: Documentation (ERD, etc.)
- `prisma`: Prisma Schema Files
- `src/`: TypeScript source code
  - `src/api/`: Client SDK
    - `src/api/structures/`: DTO structures
  - `src/controllers/`: Controller classes
  - `src/providers/`: Service providers
  - `src/executable/`: Executable programs
- `test/`: Test Automation Program

## Related Repositories

### Wrtnlabs

- [`wrtnlabs/agentica`](https://github.com/wrtnlabs/agentica)
- [`wrtnlabs/frontend`](https://github.com/wrtnlabs/frontend)
- [`wrtnlabs/connectors`](https://github.com/wrtnlabs/connectors)

### Base Libraries

- [`wrtnlabs/agentica`](https://github.com/wrtnlabs/agentica)
- [`samchon/typia`](https://github.com/samchon/typia)
- [`samchon/nestia`](https://github.com/samchon/nestia)
- [`samchon/openapi`](https://github.com/samchon/openapi)
- [`samchon/tgrid`](https://github.com/samchon/tgrid)